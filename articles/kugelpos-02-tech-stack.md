---
title: "FastAPI + MongoDB + Dapr でPOSシステムを設計した理由"
emoji: "⚙️"
type: "tech"
topics: ["POS", "FastAPI", "MongoDB", "Dapr", "AI駆動開発"]
published: true
---

![](/images/kugelpos-02/slide-1.png)

:::message
この記事の内容は動画でもご覧いただけます。
@[youtube](nIldBa8BsIM)
:::

## はじめに

前回の記事では、なぜ個人でオープンソースPOSシステム「KugelPOS」を開発することにしたのかをお話ししました。今回は技術面に踏み込み、Python 3.12 / FastAPI / MongoDB / Dapr という技術スタックの設計判断と、Claude Codeを活用したAI駆動開発の実践について詳しく解説します。

## 従来のPOSシステムの技術的課題

![](/images/kugelpos-02/slide-2.png)

POS開発の現場に長く携わってきた経験から、従来型POSシステムには共通した技術的な痛みがありました。

まず、モノリシックアーキテクチャの限界です。POSシステムは売上処理、在庫管理、商品マスタ、レポーティングなど多くの機能を含みますが、これらが密結合していると一部の変更が全体に波及し、変更コストが雪だるま式に増大します。

次に、スキーマの硬直性です。小売業の業態は多様で、スーパーマーケット、コンビニ、ドラッグストア、アパレルなど、それぞれ扱うデータの構造が微妙に異なります。RDBMSの固定スキーマでこの多様性に対応しようとすると、NULLだらけのカラムや複雑なリレーションが増殖していきます。

そして、特定インフラへの依存です。特定のクラウドやミドルウェアに密結合したシステムは、環境の移行や技術の進化への追従が困難になります。

## なぜ Python 3.12 なのか

![](/images/kugelpos-02/slide-3.png)

### 開発速度と可読性

POSシステムのビジネスロジックは複雑ですが、求められる処理速度はマイクロ秒単位ではなくミリ秒単位です。この特性を考えると、開発速度と可読性を最大化できるPythonは合理的な選択です。

Python 3.12では型ヒントの改善やパフォーマンス向上が図られており、大規模なビジネスロジックの実装にも十分対応できます。

### AI駆動開発との親和性

PythonはAIツールとの相性が極めて良い言語です。Claude CodeによるAI駆動開発において、Pythonの明確な文法と豊富な型ヒントは、AIによるコード生成・レビュー・改善の精度を高めます。AI駆動開発を前提とした技術選定という側面も、Python選択の重要な判断要素でした。

### エコシステムの充実

データ分析、機械学習との連携が容易な点も重要です。POSデータは売上分析や需要予測の基盤データであり、Pythonエコシステムとの親和性は将来の拡張において大きなメリットとなります。

### 人材の確保

OSSプロジェクトとしての成長を考えると、開発者人口の多さは重要な判断基準でした。Pythonは学習コストが低く、コントリビューターの確保においても有利に働きます。

## なぜ FastAPI なのか

### 非同期処理のネイティブサポート

FastAPIはASGI（Asynchronous Server Gateway Interface）ベースのフレームワークで、非同期処理をネイティブにサポートしています。POSシステムでは複数の外部サービス（決済端末、在庫システム、ポイントシステム等）との通信が発生するため、非同期I/Oは実用上の大きなメリットです。

### 自動的なAPI仕様書生成

FastAPIはPydanticモデルから自動的にOpenAPI（Swagger）仕様書を生成します。POSは周辺システムとの連携が多く、API仕様の正確なドキュメンテーションは開発効率と品質に直結します。複数の企業が同じAPIを利用・拡張する場面では、仕様書が常に実装と同期していることの価値は計り知れません。

### 型安全性と実行時バリデーション

Pydanticによる型定義は、開発時の型チェックと実行時のバリデーションを兼ねます。金額計算や数量管理が頻繁に発生するPOSシステムでは、不正なデータが処理パイプラインに入り込むことを水際で防ぐことが重要です。

### パフォーマンス

FastAPIはPythonのWebフレームワークの中でもトップクラスのパフォーマンスを誇ります。Starlette上に構築されており、POS端末からの大量の同時リクエストにも十分に対応できます。

## なぜ MongoDB なのか — 抽象化せず、直接利用する判断

![](/images/kugelpos-02/slide-4.png)

### スキーマの柔軟性

これがMongoDB選定の最大の理由です。小売業態ごとにデータ構造が異なるという前述の課題に対して、MongoDBのドキュメント指向モデルは自然な解決策を提供します。

例えば、アパレルの商品マスタには「サイズ」「カラー」「素材」が必要ですが、食品には「賞味期限」「アレルギー情報」「温度管理区分」が必要です。MongoDBなら、これらを同一コレクション内で柔軟に管理できます。

### なぜMongoDBは抽象化しないのか

KugelPOSではDapr（後述）を活用してインフラストラクチャの抽象化を積極的に行っていますが、MongoDBについてはあえて抽象化せず、ダイレクトに利用しています。

その理由は、MongoDBの豊富な機能をフルに活用するためです。Aggregation Pipeline、Change Streams、Atlas Searchといった強力な機能群は、汎用的なデータストア抽象層を通すと利用できなくなるか、大幅に制限されます。POSシステムでは売上集計、リアルタイムの在庫変更検知、商品の全文検索など、これらの機能が業務上不可欠であり、抽象化のメリットよりもMongoDBの機能を直接活用するメリットの方が明らかに大きいと判断しました。

### 水平スケーリング

MongoDBのシャーディング機能により、データ量やトランザクション量の増加に対して水平方向にスケールできます。店舗数の増加やデータの蓄積に対して、アーキテクチャの変更なくスケールアウトが可能です。

### 開発者体験

PythonとMongoDBの組み合わせは非常に直感的です。FastAPIで使用するPydanticモデルとMongoDBのドキュメント構造は概念的に一致しており、型安全性を維持しながらデータベース操作を自然に記述できます。Motor（非同期MongoDBドライバ）を使用することで、FastAPIの非同期処理とも自然に統合できます。

## なぜ Dapr なのか — 設計の中核を担う抽象化レイヤー

![](/images/kugelpos-02/slide-5.png)

### Daprとは何か

Dapr（Distributed Application Runtime）は、マイクロサービスの構築を簡素化する分散アプリケーションランタイムです。KugelPOSのアーキテクチャにおいて、Daprは中核的な役割を果たしています。

### インフラストラクチャの抽象化

Daprの最大の価値は、アプリケーションコードからインフラストラクチャの関心事を分離できることです。KugelPOSでは、以下の機能をDaprを通じて抽象化しています。

**状態管理（State Store）** — セッション管理や一時データの保持は、Daprの State Store APIを通じて行います。実行環境ではRedisが状態ストアとして動作していますが、アプリケーションコードからはRedisの存在を意識する必要がありません。Daprの設定を変更するだけで、別のストアに切り替えることが可能です。

**Pub/Sub メッセージング** — マイクロサービス間のイベント駆動通信を、DaprのPub/Sub APIで実現しています。メッセージブローカーの実装詳細はアプリケーションから隔離されています。

**サービス間通信** — マイクロサービス間の呼び出しを、DaprのService Invocation APIで統一的に行います。サービスディスカバリ、リトライ、mTLSによる通信の暗号化がDaprレイヤーで透過的に処理されます。

### なぜDaprによる抽象化が重要なのか

POSシステムは長期間運用されるシステムです。5年、10年というスパンで考えると、その間にインフラストラクチャの技術は大きく変化します。Daprによる抽象化は、この変化に対してアプリケーションコードを保護します。

状態ストアをRedisからAzure Cosmos DB、AWS DynamoDB、あるいは将来登場する新たなサービスに切り替える場合でも、アプリケーションコードの変更は不要です。Daprのコンポーネント設定を変更するだけで対応できます。

### 「抽象化する / しない」の判断基準

KugelPOSでは、すべてを一律に抽象化するのではなく、技術ごとに判断しています。

Daprで抽象化するもの：状態管理（Redis等）、Pub/Sub、サービス間通信。これらはインフラ環境によって最適な実装が変わるため、抽象化の恩恵が大きい領域です。

抽象化しないもの：MongoDB。データベースの豊富な機能を直接活用することの業務上の価値が、ポータビリティよりも高い領域です。

この選択的なアプローチにより、ポータビリティと機能性のバランスを取っています。

## マイクロサービス＆プラグイン構造

![](/images/kugelpos-02/slide-6.png)

### なぜマイクロサービスなのか

POSシステムは機能ドメインが明確に分離可能です。売上処理、商品管理、在庫管理、レポーティングなど、各ドメインを独立したサービスとして構築することで、独立したデプロイと個別のスケーリングが可能になります。

商品マスタの機能を更新する際に売上処理を止める必要がなく、繁忙期には売上処理サービスだけをスケールアウトするといった運用が可能です。

### プラグイン構造による拡張性

マイクロサービスに加えて、プラグイン構造を採用することで、コアシステムを変更せずに機能を拡張できる設計としています。現在、プロモーション値引き、支払種別、レシート印字レイアウト、レポートの各プラグインが実装されており、将来的には外部サービスとの連携部分もプラグイン化することを構想しています。

### Daprとマイクロサービスの相性

Daprはマイクロサービスアーキテクチャとの親和性が極めて高く、サービス間通信、分散トレーシング、セキュリティといったマイクロサービスの共通課題をランタイムレベルで解決します。これにより、各サービスの開発者はビジネスロジックに集中できます。

## マルチクラウド対応

KugelPOSはDockerコンテナをベースとし、Daprによるインフラ抽象化を組み合わせることで、特定のクラウドに依存しないポータブルな設計としています。

Azureとの親和性は高く、Azure Container Apps、Azure Cosmos DB for MongoDB、Azure Cache for Redisといったマネージドサービスとの組み合わせは実績のある構成です。しかし、アーキテクチャとしてAzureを前提にしているわけではありません。

DockerコンテナとOSSサービスの組み合わせにより、AWS（ECS/EKS、DocumentDB）やGCP（Cloud Run、MongoDB Atlas）など、他のクラウド環境でも同様に動作させることが可能です。これは、ベンダーロックインからの脱却というKugelPOSの理念と一致しています。

## AI駆動開発 — Claude Code を活用した開発手法

![](/images/kugelpos-02/slide-7.png)

### 個人開発の生産性を変えるAI駆動開発

KugelPOSの開発において、技術スタックと並んで重要な要素がAI駆動開発の実践です。Claude Codeを開発のあらゆるフェーズで活用することで、個人開発者としての生産性の限界を大きく押し広げています。

### 具体的な活用領域

**設計の壁打ち** — マイクロサービスの境界設計、APIインターフェースの設計、データモデルの検討など、アーキテクチャ上の判断を行う際にClaude Codeと対話的に設計を詰めていきます。POS業務の専門知識を持つ人間が方向性を示し、AIが選択肢の提示や設計のレビューを行うことで、一人でも多角的な視点での設計検討が可能になります。

**コードの生成と改善** — ビジネスロジックの実装、テストコードの作成、リファクタリングにClaude Codeを活用しています。ここで重要なのは、AIが生成したコードを鵜呑みにするのではなく、POS業務の専門知識に基づいて必ずレビューと修正を行うことです。AIは実装を加速しますが、業務上の正しさを判断するのは人間の役割です。

**ドキュメンテーション** — API仕様書、設計ドキュメント、README等の作成と保守にもAIを活用しています。コードの変更に合わせてドキュメントを更新する作業は、個人開発者にとって大きな負担ですが、AI駆動開発によりこの負担が大幅に軽減されます。

### AI駆動開発の本質：「人間の専門知識 × AIの生産性」

AI駆動開発の本質は、AIに開発を丸投げすることではありません。ドメイン知識を持つ人間がアーキテクチャと業務ロジックの品質を担保し、AIがその実装速度を加速するという協働モデルです。

POS業務の深い専門知識がなければ、AIがいくら高速にコードを生成しても、業務上正しいシステムにはなりません。逆に、専門知識を持つ人間がAIの生産性を活用すれば、従来なら数十人のチームが必要だった規模の開発を、個人でも実現できます。

この「人間の専門知識 × AIの生産性」という掛け算が、KugelPOSを個人開発で実現可能にした最大の要因です。

## 技術選定で意識したこと

![](/images/kugelpos-02/slide-8.png)

### 抽象化の「選択と集中」

すべてを抽象化するのではなく、抽象化する領域としない領域を明確に分けること。この判断を適切に行うためには、POS業務の深い理解とインフラ技術の両方の知見が必要です。

### OSSプロジェクトとしての持続可能性

技術スタックの選択はコントリビューターの参加しやすさに直結します。Pythonの学習コストの低さ、FastAPIのドキュメントの充実度、Daprの活発なコミュニティ、MongoDBの普及度。いずれもOSSプロジェクトの成長に寄与する要素です。

### AI駆動開発を前提とした選択

技術スタックの各要素が、AI駆動開発との相性が良いことも重視しました。Pythonの明確な文法、FastAPIの型ヒントベースの設計、MongoDBの直感的なデータモデル。これらはいずれもAIによるコード生成・理解の精度を高める要素です。

### 長期運用への備え

POSシステムは一度導入されると長期間運用されます。Daprによるインフラ抽象化は、5年後、10年後のインフラ技術の変化に対するアプリケーションの耐久性を高めます。

## おわりに

![](/images/kugelpos-02/slide-9.png)

すべての要件を満たす完璧な技術スタックは存在しません。しかし、POSシステムという業務特性、OSSとしての持続可能性、そしてAI駆動開発との親和性を総合的に考慮すると、Python / FastAPI / MongoDB / Dapr の組み合わせは現時点で最も合理的な選択だと考えています。

特に、Daprによる選択的な抽象化とMongoDBの直接活用という「抽象化する / しない」の設計判断、そしてClaude Codeを活用したAI駆動開発という開発手法は、KugelPOSの技術的な特色を最もよく表しています。

次回は「大手小売に採用されるまでにやったこと」と題して、OSSプロジェクトが企業の基幹システムに採用されるまでのプロセスをお話しします。

**KugelPOS Backend Services**
GitHub: https://github.com/kugel-masa/kugelpos-backend
ライセンス: Apache 2.0
